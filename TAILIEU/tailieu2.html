<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Tài Liệu</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/api.js"></script>
        <meta http-equiv="Content-Security-Policy" content="script-src 'self' https://apis.google.com https://www.googleapis.com 'unsafe-inline' 'unsafe-eval';">
    <style>
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            color: white;
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-6 text-center">Quản Lý Tài Liệu</h1>
        
        <div class="mb-4">
            <button id="authorize-button" class="btn btn-success me-2" style="display: none;">Đăng nhập</button>
            <button id="signout-button" class="btn btn-danger me-2" style="display: none;">Đăng xuất</button>
            <button id="them-tai-lieu-btn" class="btn btn-primary" style="display: none;">Thêm Tài Liệu Mới</button>
        </div>

        <div id="error-message" class="alert alert-danger" style="display:none;"></div>
        <div id="success-message" class="alert alert-success" style="display:none;"></div>
        
        <div class="bg-white shadow-md rounded-lg overflow-hidden">
            <table id="tai-lieu-table" class="table table-striped table-hover w-full">
                <thead class="bg-gray-100">
                    <tr>
                        <th>ID</th>
                        <th>Tên Tài Liệu</th>
                        <th>Mô Tả</th>
                        <th>Loại</th>
                        <th>Tiêu Chuẩn</th>
                        <th>Phiên Bản</th>
                        <th>Trạng Thái</th>
                        <th>Người Tạo</th>
                        <th>Ngày Tạo</th>
                        <th>Hành Động</th>
                    </tr>
                </thead>
                <tbody id="tai-lieu-body">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal Thêm/Sửa Tài Liệu -->
    <div class="modal fade" id="tai-lieu-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Thêm/Sửa Tài Liệu</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="tai-lieu-form">
                        <input type="hidden" id="row-index">
                        <input type="hidden" id="tai-lieu-id">
                        <div class="mb-3">
                            <label class="form-label">Tên Tài Liệu</label>
                            <input type="text" class="form-control" id="ten-tai-lieu" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Mô Tả</label>
                            <textarea class="form-control" id="mo-ta"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Loại Tài Liệu</label>
                            <input type="text" class="form-control" id="loai-tai-lieu">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tiêu Chuẩn</label>
                            <input type="text" class="form-control" id="tieu-chuan">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Phiên Bản</label>
                            <input type="text" class="form-control" id="phien-ban">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Trạng Thái</label>
                            <select class="form-control" id="trang-thai">
                                <option value="Mới">Mới</option>
                                <option value="Đang xử lý">Đang xử lý</option>
                                <option value="Hoàn thành">Hoàn thành</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" id="luu-tai-lieu-btn">Lưu</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Thông tin xác thực Google API
        const CLIENT_ID = '626931651727-fs8f1n9ijn6jqrn8k7qlmi9l84nhl74l.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyAuBF_gEsHGlZMedj8wZDc_sk8tyU6MVRc';
        const SHEET_ID = '1Be_ESe7P7hC42dzqKC6sP2M-IWb_A2x0gMpuhJ5T7rA';
        const SHEET_NAME = 'TAI_LIEU';
        
        // Discovery docs và scope
        const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
        const SCOPES = "https://www.googleapis.com/auth/spreadsheets";

        let currentData = [];
        const taiLieuModal = new bootstrap.Modal(document.getElementById('tai-lieu-modal'));
        
        // Elements
        const authorizeButton = document.getElementById('authorize-button');
        const signoutButton = document.getElementById('signout-button');
        const themTaiLieuBtn = document.getElementById('them-tai-lieu-btn');
        const tableBody = document.getElementById('tai-lieu-body');
        const luuTaiLieuBtn = document.getElementById('luu-tai-lieu-btn');
        const errorMessageEl = document.getElementById('error-message');
        const successMessageEl = document.getElementById('success-message');
        const loadingEl = document.getElementById('loading');

        // Form inputs
        const rowIndexInput = document.getElementById('row-index');
        const taiLieuIdInput = document.getElementById('tai-lieu-id');
        const tenTaiLieuInput = document.getElementById('ten-tai-lieu');
        const moTaInput = document.getElementById('mo-ta');
        const loaiTaiLieuInput = document.getElementById('loai-tai-lieu');
        const tieuChuanInput = document.getElementById('tieu-chuan');
        const phienBanInput = document.getElementById('phien-ban');
        const trangThaiInput = document.getElementById('trang-thai');

        function showLoading(show = true) {
            loadingEl.style.display = show ? 'flex' : 'none';
        }

        function showMessage(message, isError = false) {
            if (isError) {
                errorMessageEl.textContent = message;
                errorMessageEl.style.display = 'block';
                successMessageEl.style.display = 'none';
            } else {
                successMessageEl.textContent = message;
                successMessageEl.style.display = 'block';
                errorMessageEl.style.display = 'none';
            }
            setTimeout(() => {
                errorMessageEl.style.display = 'none';
                successMessageEl.style.display = 'none';
            }, 3000);
        }

       function initClient() {
    // Kiểm tra xem gapi có tồn tại không
    if (!window.gapi) {
        console.error('Google API client library not loaded');
        showMessage('Không thể tải Google API client library', true);
        return;
    }

    // Thêm try-catch cho việc khởi tạo
    try {
        gapi.client.init({
            apiKey: API_KEY,
            clientId: CLIENT_ID,
            discoveryDocs: DISCOVERY_DOCS,
            scope: SCOPES
        }).then(function() {
            console.log('Google API client initialized successfully');
            // Listen for sign-in state changes
            gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
            // Handle initial sign-in state
            updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
            
            authorizeButton.onclick = handleAuthClick;
            signoutButton.onclick = handleSignoutClick;
        }).catch(function(error) {
            console.error('Error initializing Google API client:', error);
            showMessage('Lỗi khởi tạo Google API: ' + error.message, true);
        });
    } catch (error) {
        console.error('Error in initClient:', error);
        showMessage('Lỗi trong quá trình khởi tạo: ' + error.message, true);
    }
}

        function updateSigninStatus(isSignedIn) {
            if (isSignedIn) {
                authorizeButton.style.display = 'none';
                signoutButton.style.display = 'inline-block';
                themTaiLieuBtn.style.display = 'inline-block';
                fetchTaiLieuData();
            } else {
                authorizeButton.style.display = 'inline-block';
                signoutButton.style.display = 'none';
                themTaiLieuBtn.style.display = 'none';
                tableBody.innerHTML = '';
            }
        }

        function handleAuthClick() {
            gapi.auth2.getAuthInstance().signIn();
        }

        function handleSignoutClick() {
            gapi.auth2.getAuthInstance().signOut();
        }

        async function fetchTaiLieuData() {
            showLoading();
            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SHEET_ID,
                    range: `${SHEET_NAME}!A:J`,
                });
                currentData = response.result.values || [];
                if (currentData.length > 0) {
                    currentData = currentData.slice(1); // Remove header row
                }
                renderTable();
            } catch (error) {
                showMessage(`Lỗi tải dữ liệu: ${error.message}`, true);
            } finally {
                showLoading(false);
            }
        }

        function renderTable() {
            tableBody.innerHTML = '';
            currentData.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row[0] || ''}</td>
                    <td>${row[1] || ''}</td>
                    <td>${row[2] || ''}</td>
                    <td>${row[3] || ''}</td>
                    <td>${row[4] || ''}</td>
                    <td>${row[5] || ''}</td>
                    <td>${row[6] || ''}</td>
                    <td>${row[7] || ''}</td>
                    <td>${row[8] || ''}</td>
                    <td>
                        <button class="btn btn-sm btn-warning me-2 edit-btn" data-index="${index}">Sửa</button>
                        <button class="btn btn-sm btn-danger delete-btn" data-index="${index}">Xóa</button>
                    </td>
                `;
                tableBody.appendChild(tr);
            });

            // Add event listeners
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', editTaiLieu);
            });

            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', deleteTaiLieu);
            });
        }

        themTaiLieuBtn.addEventListener('click', () => {
            rowIndexInput.value = '';
            taiLieuIdInput.value = '';
            tenTaiLieuInput.value = '';
            moTaInput.value = '';
            loaiTaiLieuInput.value = '';
            tieuChuanInput.value = '';
            phienBanInput.value = '';
            trangThaiInput.value = 'Mới';
            taiLieuModal.show();
        });

        function editTaiLieu(event) {
            const index = event.target.dataset.index;
            const row = currentData[index];

            rowIndexInput.value = index;
            taiLieuIdInput.value = row[0] || '';
            tenTaiLieuInput.value = row[1] || '';
            moTaInput.value = row[2] || '';
            loaiTaiLieuInput.value = row[3] || '';
            tieuChuanInput.value = row[4] || '';
            phienBanInput.value = row[5] || '';
            trangThaiInput.value = row[6] || '';

            taiLieuModal.show();
        }

        async function deleteTaiLieu(event) {
            const index = parseInt(event.target.dataset.index);
            if (!confirm('Bạn có chắc muốn xóa tài liệu này?')) return;

            showLoading();
            try {
                await gapi.client.sheets.spreadsheets.batchUpdate({
                    spreadsheetId: SHEET_ID,
                    resource: {
                        requests: [{
                            deleteDimension: {
                                range: {
                                    sheetId: 0,
                                    dimension: 'ROWS',
                                    startIndex: index + 1,
                                    endIndex: index + 2
                                }
                            }
                        }]
                    }
                });

                currentData.splice(index, 1);
                renderTable();
                showMessage('Xóa tài liệu thành công!');
            } catch (error) {
                showMessage(`Lỗi xóa tài liệu: ${error.message}`, true);
            } finally {
                showLoading(false);
            }
        }

        luuTaiLieuBtn.addEventListener('click', async () => {
            const index = rowIndexInput.value;
            const isEditMode = index !== '';

            const newRow = [
                isEditMode ? taiLieuIdInput.value : (currentData.length + 1).toString(),
                tenTaiLieuInput.value,
                moTaInput.value,
                loaiTaiLieuInput.value,
                tieuChuanInput.value,
                phienBanInput.value,
                trangThaiInput.value,
                'Admin', // Có thể thay đổi theo user đang đăng nhập
                new Date().toLocaleDateString('vi-VN')
            ];

            showLoading();
            try {
                if (isEditMode) {
                    await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: SHEET_ID,
                        range: `${SHEET_NAME}!A${parseInt(index) + 2}:I${parseInt(index) + 2}`,
                        valueInputOption: 'RAW',
                        resource: { values: [newRow] }
                    });
                    currentData[index] = newRow;
                } else {
                    await gapi.client.sheets.spreadsheets.values.append({
                        spreadsheetId: SHEET_ID,
                        range: `${SHEET_NAME}!A:I`,
                        valueInputOption: 'RAW',
                        resource: { values: [newRow] }
                    });
                    currentData.push(newRow);
                }

                renderTable();
                taiLieuModal.hide();
                showMessage(`${isEditMode ? 'Sửa' : 'Thêm'} tài liệu thành công!`);
            } catch (error) {
                showMessage(`Lỗi ${isEditMode ? 'sửa' : 'thêm'} tài liệu: ${error.message}`, true);
            } finally {
                showLoading(false);
            }
        });

// Sửa lại hàm loadGoogleAPI
function loadGoogleAPI() {
    const script = document.createElement('script');
    script.src = 'https://apis.google.com/js/api.js';
    script.onload = function() {
        console.log('Google API script loaded');
        gapi.load('client:auth2', function() {
            console.log('Google API client loaded');
            initClient();
        });
    };
    script.onerror = function() {
        console.error('Failed to load Google API script');
        showMessage('Không thể tải Google API script', true);
    };
    document.body.appendChild(script);
}

        document.addEventListener('DOMContentLoaded', loadGoogleAPI);
    </script>
</body>
</html>
