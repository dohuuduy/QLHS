<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Tài Liệu</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-6 text-center">Quản Lý Danh Sách Tài Liệu 2</h1>
        
        <div id="error-message" class="alert alert-danger" style="display:none;"></div>
        
        <!-- Nút Thêm Mới -->
        <div class="mb-4">
            <button id="them-moi-btn" class="btn btn-primary">
                Thêm Tài Liệu Mới
            </button>
        </div>

        <!-- Modal Thêm/Sửa Tài Liệu -->
        <div id="tai-lieu-modal" class="modal" tabindex="-1" style="display:none;">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 id="modal-title" class="modal-title">Thêm Tài Liệu Mới</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="tai-lieu-form">
                            <input type="hidden" id="row-index" name="rowIndex">
                            <div class="mb-3">
                                <label for="ten-tai-lieu" class="form-label">Tên Tài Liệu</label>
                                <input type="text" class="form-control" id="ten-tai-lieu" required>
                            </div>
                            <div class="mb-3">
                                <label for="mo-ta" class="form-label">Mô Tả</label>
                                <textarea class="form-control" id="mo-ta"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="loai" class="form-label">Loại</label>
                                <input type="text" class="form-control" id="loai">
                            </div>
                            <div class="mb-3">
                                <label for="tieu-chuan" class="form-label">Tiêu Chuẩn</label>
                                <input type="text" class="form-control" id="tieu-chuan">
                            </div>
                            <div class="mb-3">
                                <label for="phien-ban" class="form-label">Phiên Bản</label>
                                <input type="text" class="form-control" id="phien-ban">
                            </div>
                            <div class="mb-3">
                                <label for="trang-thai" class="form-label">Trạng Thái</label>
                                <select class="form-select" id="trang-thai">
                                    <option value="Mới Tạo">Mới Tạo</option>
                                    <option value="Đang Sử Dụng">Đang Sử Dụng</option>
                                    <option value="Ngưng Sử Dụng">Ngưng Sử Dụng</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="nguoi-tao" class="form-label">Người Tạo</label>
                                <input type="text" class="form-control" id="nguoi-tao">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="dong-modal">Đóng</button>
                        <button type="button" class="btn btn-primary" id="luu-tai-lieu">Lưu</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bảng Tài Liệu -->
        <div class="bg-white shadow-md rounded-lg overflow-hidden">
            <table id="tai-lieu-table" class="table table-striped table-hover w-full">
                <thead class="bg-gray-100">
                    <tr>
                        <th>ID</th>
                        <th>Tên Tài Liệu</th>
                        <th>Mô Tả</th>
                        <th>Loại</th>
                        <th>Tiêu Chuẩn</th>
                        <th>Phiên Bản</th>
                        <th>Trạng Thái</th>
                        <th>Người Tạo</th>
                        <th>Ngày Tạo</th>
                        <th>Hành Động</th>
                    </tr>
                </thead>
                <tbody id="tai-lieu-body">
                    <!-- Dữ liệu sẽ được load động -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const SHEET_ID = '1Be_ESe7P7hC42dzqKC6sP2M-IWb_A2x0gMpuhJ5T7rA';
        const API_KEY = 'AIzaSyAuBF_gEsHGlZMedj8wZDc_sk8tyU6MVRc';
        const SHEET_NAME = 'TAI_LIEU';

        class TaiLieuManager {
            constructor() {
                this.initEventListeners();
            }

            initEventListeners() {
                document.getElementById('them-moi-btn').addEventListener('click', () => this.moModalThemMoi());
                document.getElementById('luu-tai-lieu').addEventListener('click', () => this.luuTaiLieu());
                document.getElementById('dong-modal').addEventListener('click', () => this.dongModal());
            }

            async fetchTaiLieuData() {
                const errorMessageEl = document.getElementById('error-message');
                const tableBody = document.getElementById('tai-lieu-body');
                
                try {
                    const apiUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SHEET_NAME}!A:J?key=${API_KEY}`;
                    const response = await fetch(apiUrl);

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Error Response Text:', errorText);
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();

                    if (!data.values || data.values.length === 0) {
                        errorMessageEl.textContent = 'Không có dữ liệu trong sheet';
                        errorMessageEl.style.display = 'block';
                        return;
                    }

                    const rows = data.values.slice(1); // Bỏ qua hàng tiêu đề

                    tableBody.innerHTML = '';

                    rows.forEach((row, index) => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${row[0] || ''}</td>
                            <td>${row[1] || ''}</td>
                            <td>${row[2] || ''}</td>
                            <td>${row[3] || ''}</td>
                            <td>${row[4] || ''}</td>
                            <td>${row[5] || ''}</td>
                            <td>${row[6] || ''}</td>
                            <td>${row[7] || ''}</td>
                            <td>${row[8] || ''}</td>
                            <td>
                                <button class="btn btn-sm btn-warning sua-btn" data-index="${index + 2}">Sửa</button>
                                <button class="btn btn-sm btn-danger xoa-btn" data-index="${index + 2}">Xóa</button>
                            </td>
                        `;
                        tableBody.appendChild(tr);
                    });

                    // Gắn sự kiện cho các nút Sửa và Xóa
                    document.querySelectorAll('.sua-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => this.suaTaiLieu(e));
                    });

                    document.querySelectorAll('.xoa-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => this.xoaTaiLieu(e));
                    });
                } catch (error) {
                    console.error('Lỗi chi tiết:', error);
                    errorMessageEl.textContent = `Lỗi tải dữ liệu: ${error.message}`;
                    errorMessageEl.style.display = 'block';
                }
            }

            moModalThemMoi() {
                const modal = document.getElementById('tai-lieu-modal');
                const modalTitle = document.getElementById('modal-title');
                modalTitle.textContent = 'Thêm Tài Liệu Mới';
                
                // Đặt lại form
                document.getElementById('row-index').value = '';
                document.getElementById('ten-tai-lieu').value = '';
                document.getElementById('mo-ta').value = '';
                document.getElementById('loai').value = '';
                document.getElementById('tieu-chuan').value = '';
                document.getElementById('phien-ban').value = '';
                document.getElementById('trang-thai').value = 'Mới Tạo';
                document.getElementById('nguoi-tao').value = '';

                modal.style.display = 'block';
            }

            suaTaiLieu(e) {
                const rowIndex = e.target.getAttribute('data-index');
                const modal = document.getElementById('tai-lieu-modal');
                const modalTitle = document.getElementById('modal-title');
                modalTitle.textContent = 'Sửa Tài Liệu';

                // Lấy dữ liệu từ hàng được chọn
                const row = e.target.closest('tr');
                const cells = row.querySelectorAll('td');

                document.getElementById('row-index').value = rowIndex;
                document.getElementById('ten-tai-lieu').value = cells[1].textContent;
                document.getElementById('mo-ta').value = cells[2].textContent;
                document.getElementById('loai').value = cells[3].textContent;
                document.getElementById('tieu-chuan').value = cells[4].textContent;
                document.getElementById('phien-ban').value = cells[5].textContent;
                document.getElementById('trang-thai').value = cells[6].textContent;
                document.getElementById('nguoi-tao').value = cells[7].textContent;

                modal.style.display = 'block';
            }

            dongModal() {
                const modal = document.getElementById('tai-lieu-modal');
                modal.style.display = 'none';
            }

            async luuTaiLieu() {
                const rowIndex = document.getElementById('row-index').value;
                const tenTaiLieu = document.getElementById('ten-tai-lieu').value;
                const moTa = document.getElementById('mo-ta').value;
                const loai = document.getElementById('loai').value;
                const tieuChuan = document.getElementById('tieu-chuan').value;
                const phienBan = document.getElementById('phien-ban').value;
                const trangThai = document.getElementById('trang-thai').value;
                const nguoiTao = document.getElementById('nguoi-tao').value;
                const ngayTao = new Date().toLocaleDateString();

                const errorMessageEl = document.getElementById('error-message');

                try {
                    // Xác định URL API phù hợp với việc thêm hoặc sửa
                    let apiUrl, method, body;
                    if (rowIndex) {
                        // Sửa tài liệu
                        apiUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SHEET_NAME}!A${rowIndex}:I${rowIndex}?valueInputOption=USER_ENTERED&key=${API_KEY}`;
                        method = 'PUT';
                        body = JSON.stringify({
                            range: `${SHEET_NAME}!A${rowIndex}:I${rowIndex}`,
                            majorDimension: 'ROWS',
                            values: [[
                                rowIndex - 1, // ID tự động
                                tenTaiLieu, 
                                moTa, 
                                loai, 
                                tieuChuan, 
                                phienBan, 
                                trangThai, 
                                nguoiTao, 
                                ngayTao
                            ]]
                        });
                    } else {
                        // Thêm tài liệu mới
                        apiUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SHEET_NAME}!A:I:append?valueInputOption=USER_ENTERED&key=${API_KEY}`;
                        method = 'POST';
                        body = JSON.stringify({
                            range: `${SHEET_NAME}!A:I`,
                            majorDimension: 'ROWS',
                            values: [[
                                '', // ID để trống để tự động điền
                                tenTaiLieu, 
                                moTa, 
                                loai, 
                                tieuChuan, 
                                phienBan, 
                                trangThai, 
                                nguoiTao, 
                                ngayTao
                            ]]
                        });
                    }

                    const response = await fetch(apiUrl, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: body
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Error Response Text:', errorText);
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    // Đóng modal và làm mới dữ liệu
                    this.dongModal();
                    this.fetchTaiLieuData();

                    errorMessageEl.style.display = 'none';
                } catch (error) {
                    console.error('Lỗi chi tiết:',
