<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Tài Liệu</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-6 text-center">Quản Lý Tài Liệu</h1>
        
        <div class="mb-4">
            <button id="them-tai-lieu-btn" class="btn btn-primary">Thêm Tài Liệu Mới</button>
        </div>

        <div id="error-message" class="alert alert-danger" style="display:none;"></div>
        <div id="success-message" class="alert alert-success" style="display:none;"></div>
        
        <div class="bg-white shadow-md rounded-lg overflow-hidden">
            <table id="tai-lieu-table" class="table table-striped table-hover w-full">
                <thead class="bg-gray-100">
                    <tr>
                        <th>ID</th>
                        <th>Tên Tài Liệu</th>
                        <th>Mô Tả</th>
                        <th>Loại</th>
                        <th>Tiêu Chuẩn</th>
                        <th>Phiên Bản</th>
                        <th>Trạng Thái</th>
                        <th>Người Tạo</th>
                        <th>Ngày Tạo</th>
                        <th>Hành Động</th>
                    </tr>
                </thead>
                <tbody id="tai-lieu-body">
                    <!-- Dữ liệu sẽ được load động -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal Thêm/Sửa Tài Liệu -->
    <div class="modal fade" id="tai-lieu-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Thêm/Sửa Tài Liệu</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="tai-lieu-form">
                        <input type="hidden" id="row-index">
                        <input type="hidden" id="tai-lieu-id">
                        <div class="mb-3">
                            <label class="form-label">Tên Tài Liệu</label>
                            <input type="text" class="form-control" id="ten-tai-lieu" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Mô Tả</label>
                            <textarea class="form-control" id="mo-ta"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Loại Tài Liệu</label>
                            <input type="text" class="form-control" id="loai-tai-lieu">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tiêu Chuẩn</label>
                            <input type="text" class="form-control" id="tieu-chuan">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Phiên Bản</label>
                            <input type="text" class="form-control" id="phien-ban">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Trạng Thái</label>
                            <input type="text" class="form-control" id="trang-thai">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" id="luu-tai-lieu-btn">Lưu</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const SHEET_ID = '1Be_ESe7P7hC42dzqKC6sP2M-IWb_A2x0gMpuhJ5T7rA';
        const API_KEY = 'AIzaSyAuBF_gEsHGlZMedj8wZDc_sk8tyU6MVRc';
        const SHEET_NAME = 'TAI_LIEU';
        let currentData = [];

        // Modal Bootstrap
        const taiLieuModal = new bootstrap.Modal(document.getElementById('tai-lieu-modal'));
        
        // Các element
        const tableBody = document.getElementById('tai-lieu-body');
        const themTaiLieuBtn = document.getElementById('them-tai-lieu-btn');
        const luuTaiLieuBtn = document.getElementById('luu-tai-lieu-btn');
        const errorMessageEl = document.getElementById('error-message');
        const successMessageEl = document.getElementById('success-message');

        // Các input trong form
        const rowIndexInput = document.getElementById('row-index');
        const taiLieuIdInput = document.getElementById('tai-lieu-id');
        const tenTaiLieuInput = document.getElementById('ten-tai-lieu');
        const moTaInput = document.getElementById('mo-ta');
        const loaiTaiLieuInput = document.getElementById('loai-tai-lieu');
        const tieuChuanInput = document.getElementById('tieu-chuan');
        const phienBanInput = document.getElementById('phien-ban');
        const trangThaiInput = document.getElementById('trang-thai');

        function showMessage(message, isError = false) {
            if (isError) {
                errorMessageEl.textContent = message;
                errorMessageEl.style.display = 'block';
                successMessageEl.style.display = 'none';
            } else {
                successMessageEl.textContent = message;
                successMessageEl.style.display = 'block';
                errorMessageEl.style.display = 'none';
            }
        }

        async function fetchTaiLieuData() {
            try {
                const apiUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SHEET_NAME}!A:J?key=${API_KEY}`;
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                currentData = data.values.slice(1); // Bỏ qua hàng tiêu đề
                renderTable();
            } catch (error) {
                showMessage(`Lỗi tải dữ liệu: ${error.message}`, true);
            }
        }

        function renderTable() {
            tableBody.innerHTML = '';
            currentData.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row[0] || ''}</td>
                    <td>${row[1] || ''}</td>
                    <td>${row[2] || ''}</td>
                    <td>${row[3] || ''}</td>
                    <td>${row[4] || ''}</td>
                    <td>${row[5] || ''}</td>
                    <td>${row[6] || ''}</td>
                    <td>${row[7] || ''}</td>
                    <td>${row[8] || ''}</td>
                    <td>
                        <button class="btn btn-sm btn-warning me-2 edit-btn" data-index="${index}">Sửa</button>
                        <button class="btn btn-sm btn-danger delete-btn" data-index="${index}">Xóa</button>
                    </td>
                `;
                tableBody.appendChild(tr);
            });

            // Gắn sự kiện cho nút Sửa và Xóa
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', editTaiLieu);
            });

            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', deleteTaiLieu);
            });
        }

        // Thêm Tài Liệu
        themTaiLieuBtn.addEventListener('click', () => {
            // Reset form
            rowIndexInput.value = '';
            taiLieuIdInput.value = '';
            tenTaiLieuInput.value = '';
            moTaInput.value = '';
            loaiTaiLieuInput.value = '';
            tieuChuanInput.value = '';
            phienBanInput.value = '';
            trangThaiInput.value = '';

            taiLieuModal.show();
        });

        // Sửa Tài Liệu
        function editTaiLieu(event) {
            const index = event.target.dataset.index;
            const row = currentData[index];

            // Điền thông tin vào form
            rowIndexInput.value = index;
            taiLieuIdInput.value = row[0] || '';
            tenTaiLieuInput.value = row[1] || '';
            moTaInput.value = row[2] || '';
            loaiTaiLieuInput.value = row[3] || '';
            tieuChuanInput.value = row[4] || '';
            phienBanInput.value = row[5] || '';
            trangThaiInput.value = row[6] || '';

            taiLieuModal.show();
        }

        // Xóa Tài Liệu
        async function deleteTaiLieu(event) {
            const index = event.target.dataset.index;
            const taiLieuId = currentData[index][0];

            if(confirm('Bạn có chắc muốn xóa tài liệu này?')) {
                try {
                    const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SHEET_NAME}!A${index + 2}:J${index + 2}?key=${API_KEY}`, {
                        method: 'DELETE'
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    // Xóa dòng khỏi mảng local
                    currentData.splice(index, 1);
                    renderTable();
                    showMessage('Xóa tài liệu thành công!');
                } catch (error) {
                    showMessage(`Lỗi xóa tài liệu: ${error.message}`, true);
                }
            }
        }

        // Lưu Tài Liệu
        luuTaiLieuBtn.addEventListener('click', async () => {
            const index = rowIndexInput.value;
            const isEditMode = index !== '';

            const newRow = [
                isEditMode ? taiLieuIdInput.value : (currentData.length + 1).toString(),
                tenTaiLieuInput.value,
                moTaInput.value,
                loaiTaiLieuInput.value,
                tieuChuanInput.value,
                phienBanInput.value,
                trangThaiInput.value,
                'Người Dùng', // Người tạo (tạm thời)
                new Date().toLocaleDateString(), // Ngày tạo
            ];

            try {
                if (isEditMode) {
                    // Sửa
                    const response = await fetch(
                        `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SHEET_NAME}!A${parseInt(index) + 2}:J${parseInt(index) + 2}?key=${API_KEY}`,
                        {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                values: [newRow]
                            })
                        }
                    );

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    currentData[index] = newRow;
                } else {
                    // Thêm mới
                    const response = await fetch(
                        `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SHEET_NAME}!A${currentData.length + 2}:J${currentData.length + 2}?key=${API_KEY}`,
                        {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                values: [newRow]
                            })
                        }
                    );

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    currentData.push(newRow);
                }

                renderTable();
                taiLieuModal.hide();
                showMessage(`${isEditMode ? 'Sửa' : 'Thêm'} tài liệu thành công!`);
            } catch (error) {
                showMessage(`Lỗi ${isEditMode ? 'sửa' : 'thêm'} tài liệu: ${error.message}`, true);
            }
        });

        // Khởi tạo
        document.addEventListener('DOMContentLoaded', fetchTaiLieuData);
    </script>
</body>
</html>
